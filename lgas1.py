import streamlit as st
import pandas as pd
from datetime import datetime
import pytz
import time
from st_supabase_connection import SupabaseConnection

# 1. INITIALIZE & DB CONNECTION
if "last_refresh" not in st.session_state:
    st.session_state["last_refresh"] = "Initializing..."

conn = st.connection("supabase", type=SupabaseConnection)

@st.cache_data(ttl=60)
def load_supabase_data():
    try:
        response = conn.table("cylinders").select("*").execute()
        df = pd.DataFrame(response.data)
        ist = pytz.timezone('Asia/Kolkata')
        st.session_state["last_refresh"] = datetime.now(ist).strftime("%I:%M:%S %p")
        
        if not df.empty:
            # Ensure Location_PIN is a string for cleaner display
            df["Location_PIN"] = df["Location_PIN"].astype(str).str.strip()
            for col in ["Last_Fill_Date", "Last_Test_Date", "Next_Test_Due"]:
                if col in df.columns:
                    df[col] = pd.to_datetime(df[col], errors='coerce')
        return df
    except Exception as e:
        st.session_state["last_refresh"] = "Refresh Error"
        st.error(f"Database Connection Error: {e}")
        return pd.DataFrame()

df = load_supabase_data()

# 2. SIDEBAR NAVIGATION
st.sidebar.title("Cylinder Management 2026")
st.sidebar.info("Operations - Domestic Gas Testing")

if st.sidebar.button("üîÑ Refresh Data Now"):
    st.cache_data.clear()
    st.rerun()

page = st.sidebar.selectbox(
    "Select Page",
    ["Dashboard", "Cylinder Finder", "Return & Penalty Log", "Add New Cylinder"]
)

# 3. DASHBOARD PAGE
if page == "Dashboard":
    st.title("Live Fleet Dashboard")
    
    if not df.empty:
        # 1. Setup Dates
        ist = pytz.timezone('Asia/Kolkata')
        today = datetime.now(ist).date()

        # 2. Metrics
        col1, col2, col3 = st.columns(3)
        col1.metric("Total Units", len(df))
        overdue_count = len(df[df["Next_Test_Due"].dt.date <= today])
        col2.metric("Overdue (Test)", overdue_count)
        col3.metric("Empty Stock", len(df[df["Status"] == "Empty"]))

        # 3. Style Function (Dark Grey / Near Black)
        def highlight_overdue(row):
            # Hex #1E1E1E is a soft "Onyx" grey close to black
            if row["Next_Test_Due"].date() <= today:
                return ['background-color: #303030; color: white; font-weight: italic'] * len(row)
            return [''] * len(row)

        styled_df = df.style.apply(highlight_overdue, axis=1)

        st.subheader("Inventory Overview")
        
        # 4. Display with Hidden Index
        st.dataframe(styled_df, use_container_width=True, hide_index=True)
        
        # 5. Footer Note
        st.caption("**Grey Rows indicate cylinders that have exceeded their safety test date.")
    else:
        st.warning("No data found.")

# 4. CYLINDER FINDER (Hardware Scanner Friendly)
# --- CYLINDER FINDER ---
elif page == "Cylinder Finder":
    st.title("üîç Advanced Cylinder Search")
    
    # 1. Search Inputs
    colA, colB, colC = st.columns(3)
    with colA:
        s_id = st.text_input("Search ID (Scan Now)").strip().upper()
    with colB:
        s_name = st.text_input("Search Customer").strip()
    with colC:
        s_status = st.selectbox("Filter Status", ["All", "Full", "Empty", "Damaged"])

    # 2. Date Setup
    ist = pytz.timezone('Asia/Kolkata')
    today = datetime.now(ist).date()

    # 3. Filtering Logic
    f_df = df.copy()
    if s_id:
        f_df = f_df[f_df["Cylinder_ID"].str.upper().str.contains(s_id, na=False)]
    if s_name:
        f_df = f_df[f_df["Customer_Name"].str.contains(s_name, case=False, na=False)]
    if s_status != "All":
        f_df = f_df[f_df["Status"] == s_status]

    # 4. FIXED ALERT LOGIC (Only triggers for ID or Customer searches)
    # We only show the Alert/Success messages if the user typed something in ID or Name
    if s_id or s_name:
        if not f_df.empty:
            overdue_list = f_df[f_df["Next_Test_Due"].dt.date <= today]
            num_overdue = len(overdue_list)

            if num_overdue > 0:
                if s_id and num_overdue == 1:
                    due_date = overdue_list.iloc[0]["Next_Test_Due"].date()
                    st.error(f"‚ö†Ô∏è SAFETY ALERT: Cylinder {s_id} is OVERDUE! (Due: {due_date})")
                else:
                    st.error(f"‚ö†Ô∏è ATTENTION: Found {num_overdue} overdue cylinder(s) for '{s_id if s_id else s_name}'")
            else:
                st.success(f"‚úÖ No overdue cylinders found for this search.")
        else:
            st.warning("No matching cylinders found.")

    # 5. Apply Dark-Grey Styling (Always active so you can still see them in the list)
    def highlight_overdue(row):
        if row["Next_Test_Due"].date() <= today:
            return ['background-color: #1E1E1E; color: #E0E0E0; font-weight: bold'] * len(row)
        return [''] * len(row)

    styled_f_df = f_df.style.apply(highlight_overdue, axis=1)

    st.subheader(f"Results Found: {len(f_df)}")
    st.dataframe(styled_f_df, use_container_width=True, hide_index=True)


# 5. RETURN & PENALTY LOG
elif page == "Return & Penalty Log":
    st.title("Cylinder Return Audit")
    if not df.empty:
        # You can also scan into a selectbox if the ID matches exactly
        target_id = st.selectbox("Select ID for Return", options=df["Cylinder_ID"].unique())
        with st.form("audit_form"):
            condition = st.selectbox("Condition", ["Good", "Dented", "Leaking", "Valve Damage"])
            if st.form_submit_button("Submit Return"):
                new_status = "Empty" if condition == "Good" else "Damaged"
                try:
                    conn.table("cylinders").update({"Status": new_status, "Fill_Percent": 0}).eq("Cylinder_ID", target_id).execute()
                    st.success(f"Cylinder {target_id} processed!")
                    time.sleep(2)
                    st.cache_data.clear()
                    st.rerun()
                except Exception as e:
                    st.error(f"Update failed: {e}")

# 6. ADD NEW CYLINDER (Hardware Scanner Friendly)
elif page == "Add New Cylinder":
    st.title("Register New Cylinder")
    
    # clear_on_submit=True is critical for scanners so you don't have to delete the old ID manually
    with st.form("new_entry_form", clear_on_submit=True):
        st.write("Scan the cylinder barcode to auto-fill ID.")
        c_id = st.text_input("New Cylinder ID").strip().upper()
        
        cust = st.text_input("Customer Name", value="Internal Stock")
        pin = st.text_input("Location PIN", value="500001", max_chars=6)
        
        cap_val = st.selectbox("Capacity (kg)", options=[5.0, 10.0, 14.2, 19.0, 47.5], index=2)
        
        if st.form_submit_button("Add Cylinder"):
            if not c_id:
                st.error("Missing Cylinder ID!")
            else:
                today = datetime.now().date()
                payload = {
                    "Cylinder_ID": str(c_id),
                    "Customer_Name": str(cust),
                    "Location_PIN": int(pin) if pin.isdigit() else 0,
                    "Capacity_kg": float(cap_val),
                    "Fill_Percent": 100,
                    "Status": "Full",
                    "Last_Fill_Date": str(today),
                    "Last_Test_Date": str(today),
                    "Next_Test_Due": str(today + pd.Timedelta(days=1825)),
                    "Overdue": False
                }
                try:
                    conn.table("cylinders").insert(payload).execute()
                    st.success(f"Cylinder {c_id} added successfully!")
                    time.sleep(2)
                    st.cache_data.clear()
                    st.rerun()
                except Exception as e:
                    st.error(f"Database Error: {e}")

# 7. FOOTER
st.markdown("---")
last_time = st.session_state["last_refresh"]
footer_text = f"""
<div style="text-align: center; color: grey; font-size: 0.85em; font-family: sans-serif;">
    <p><b> Developed by </b> KWS </p>
    <p style="color: #007bff;"><b>Last Refresh:</b> {last_time} IST</p>
    <p> Cylinder Management System v1.2</p>
</div>
"""
st.markdown(footer_text, unsafe_allow_html=True)











